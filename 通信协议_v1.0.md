# 智能环境监测系统 通信协议文档 v1.0

**版本**: v1.0  
**日期**: 2025-12-30  
**适用设备**: STM32F103 (下位机) <-> ESP-01S / PC (上位机)

---

## 1. 物理层 (Physical Layer)

*   **接口**: UART (TTL Level)
*   **波特率**: **115200 bps**
*   **数据位**: 8
*   **停止位**: 1
*   **校验位**: None (无)
*   **流控**: None (无)

---

## 2. 数据链路层 (Data Link Layer)

采用定长帧头 + 变长载荷 (TLV) + 校验尾的设计。

### 2.1 帧结构

| 字节偏移 | 字段名 | 长度 (Byte) | 描述 |
| :--- | :--- | :--- | :--- |
| 0 | **SOF** | 1 | 帧起始标志，固定为 **`0xAA`** |
| 1 | **LEN** | 1 | 帧体长度 = `1 (TYPE) + Payload长度` |
| 2 | **TYPE** | 1 | 消息类型 (Message Type) |
| 3...N | **Payload**| N-1 | 消息载荷 (TLV 格式) |
| N+1 | **CRC** | 1 | 异或校验 (XOR Checksum) |

*   **CRC 计算范围**: 从 `SOF` (Byte 0) 到 `Payload` 结束的所有字节。不包含 CRC 本身。
*   **最小帧长**: 4 字节 (SOF + LEN=1 + TYPE + CRC)。

---

## 3. 应用层 (Application Layer)

### 3.1 消息类型 (TYPE)

| TYPE (Hex) | 名称 | 描述 |
| :--- | :--- | :--- |
| `0x01` | **SensorReport** | 下位机 -> 上位机，传感器数据上报 |
| `0x02` | **ActuatorStatus**| 下位机 -> 上位机，执行器状态反馈 |
| `0x10` | **Command** | 上位机 -> 下位机，控制命令 |
| `0x11` | **CommandAck** | 下位机 -> 上位机，命令接收确认 |
| `0x20` | **Heartbeat** | 双向，心跳保活 (可选) |

### 3.2 标签定义 (TAG)

**传感器 (Sensor Tags)**:
| TAG | 名称 | 数据类型 | 单位/说明 |
| :--- | :--- | :--- | :--- |
| `0x01` | SoilMoisture | `u16` (2 Byte) | ABC原始值 (0-4095)，值越大越湿 |
| `0x02` | Temperature | `i16` (2 Byte) | 0.01 摄氏度 (如 2500 = 25.00°C) |
| `0x03` | Humidity | `u16` (2 Byte) | 0.01 %RH (如 5000 = 50.00%) |
| `0x04` | LightIntensity | `u16` (2 Byte) | Lux (流明) |

**执行器 (Actuator Tags)**:
| TAG | 名称 | 说明 |
| :--- | :--- | :--- |
| `0x10` | Fan | 风扇 |
| `0x11` | Pump | 水泵 |
| `0x12` | Light | 补光灯 |
| `0x13` | Buzzer | 蜂鸣器 |

---

## 4. 详细帧格式示例

### 4.1 传感器上报 (SensorData)
**方向**: 下位机 -> 上位机  
**Payload 格式**: TLV (Tag-Length-Value) 列表。  
*   TLV 结构: `[TAG]` + `[LEN]` + `[VAL_HI]` + `[VAL_LO]` (大端序)

**示例**: 上报 温度 25.00°C (`2500` = `0x09C4`)
```text
Raw: AA 05 01 02 02 09 C4 XX
```
*   `AA`: SOF
*   `05`: LEN (1 byte TYPE + 4 bytes Payload)
*   `01`: TYPE (SensorReport)
*   `02`: TAG (Temperature)
*   `02`: LEN (Tag Value Length)
*   `09`: Value Hi
*   `C4`: Value Lo
*   `XX`: XOR Checksum

### 4.2 控制命令 (Command)
**方向**: 上位机 -> 下位机   
**Payload 格式**: 
1.  **开关控制**: `[TAG] [LEN=1] [STATE]`
    *   State: `0x01` (ON), `0x00` (OFF)
2.  **脉冲控制 (如开5秒)**: `[TAG] [LEN=2] [TIME_HI] [TIME_LO]`
    *   Time: 毫秒 (u16, Big Endian)。隐含开启。

**示例1**: 打开风扇 (Fan ON)
```text
Raw: AA 04 10 10 01 01 XX
```
*   `AA`: SOF
*   `04`: LEN (1 byte TYPE + 3 bytes Payload)
*   `10`: TYPE (Command)
*   `10`: TAG (Fan)
*   `01`: LEN (Payload Length)
*   `01`: Value (ON)
*   `XX`: CRC

**示例2**: 蜂鸣器响 100ms (`100` = `0x0064`)
```text
Raw: AA 05 10 13 02 00 64 XX
```
*   `AA`: SOF
*   `05`: LEN
*   `10`: TYPE (Command)
*   `13`: TAG (Buzzer)
*   `02`: LEN (2 bytes)
*   `00 64`: Value (100ms)
*   `XX`: CRC

### 4.3 执行器状态反馈 (ActuatorStatus)
**方向**: 下位机 -> 上位机  
当执行器状态改变（无论是被命令触发，还是脉冲结束自动关闭）时上报。
格式: `[TAG] [LEN=1] [STATE]`

**示例**: 灯已关闭 (Light OFF)
```text
Raw: AA 04 02 12 01 00 XX
```
*   `02`: TYPE (ActuatorStatus)
*   `12`: TAG (Light)
*   `00`: State (OFF)

### 4.4 命令确认 (CommandAck)
**方向**: 下位机 -> 上位机  
收到命令并校验通过后立即回复。
格式: `[TAG] [LEN=1] [SUCCESS]`

**示例**: 收到风扇命令确认
```text
Raw: AA 04 11 10 01 01 XX
```
*   `11`: TYPE (CommandAck)
*   `10`: TAG (Fan)
*   `01`: Success (True)

---

## 5. 开发建议 (For 上位机)
1.  **校验**: 接收时务必校验 CRC，丢弃校验失败的帧。
2.  **断帧**: 建议使用 `0xAA`作为起始检测，结合 `LEN` 字段判定帧尾。若在 `LEN` 指示的长度内又遇到 `0xAA` 且前面的 CRC 校验失败，应尝试重新同步。
3.  **心跳**: 虽然协议定义了心跳 (`0x20`)，但目前下美机每秒都会自动上报传感器数据，实际上起到了心跳作用。
